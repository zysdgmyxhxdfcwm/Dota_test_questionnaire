<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dota 2 Draft Rating Survey</title>
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f4f4; /* 浅灰色背景 */
            color: #333; /* 深色文字 */
            margin: 0;
            padding: 20px;
        }
        .survey-container {
            max-width: 950px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff; /* 白色卡片背景 */
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); /* 更柔和的阴影 */
        }
        .draft-question {
            border-bottom: 2px solid #ddd; /* 浅色边框 */
            padding-bottom: 20px;
            margin-bottom: 30px;
        }
        .draft-question:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }
        .draft-question h3 {
            text-align: center;
            font-size: 1.5em;
            color: #111; /* 深色标题 */
        }
        .draft-display {
            display: flex;
            justify-content: space-around;
            margin-bottom: 20px;
            background-color: #f9f9f9; /* 极浅的灰色背景 */
            border-radius: 8px;
            padding: 15px;
        }
        .team-column {
            width: 48%;
            display: flex;
            flex-direction: column;
        }
        .team-column h4 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 1.8em;
            font-weight: bold;
        }
        #radiant h4 {
            color: #61a657; /* 调整了绿色以在白色上更清晰 */
        }
        #dire h4 {
            color: #e5493f; /* 调整了红色以在白色上更清晰 */
        }
        .picks-section, .bans-section {
            background-color: #f0f0f0; /* 浅灰色块 */
            border-radius: 6px;
            padding: 10px;
            margin-bottom: 10px;
            min-height: 80px; /* Ensure a minimum height */
        }
        .picks-section h5, .bans-section h5 {
            margin: 0 0 10px 0;
            text-align: center;
            font-size: 1.1em;
            color: #555; /* 深色子标题 */
            border-bottom: 1px solid #ddd; /* 浅色边框 */
            padding-bottom: 5px;
        }
        .hero-images-container {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 5px;
            min-height: 40px; /* Minimum height even if empty */
        }
        .hero-image {
            width: 64px; 
            height: auto; 
            border-radius: 4px;
            transition: transform 0.2s ease;
        }
        .hero-image:hover {
            transform: scale(1.1);
        }
        .picks-section .hero-image {
            border: 3px solid gold;
            box-shadow: 0 0 10px gold;
        }
        .bans-section .hero-image {
            border: 3px solid #bbb; /* 浅灰色边框 */
            filter: grayscale(70%) opacity(0.8); /* 调整了Ban的样式以适应浅色背景 */
        }
        .options-container {
            padding: 10px 20px;
        }
        .options-container legend {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 10px;
            color: #222; /* 深色文字 */
            width: 100%; /* 确保legend占据整行 */
        }
        
        /* --- 新增：用于将选项排成一行的Flex容器 --- */
        .options-flex-wrapper {
            display: flex;
            flex-wrap: wrap; /* 在小屏幕上换行 */
            justify-content: space-around; /* 均匀分布 */
            margin-top: 10px;
        }
        /* --- 修改：选项div的样式 --- */
        .options-container div {
            flex-basis: 22%; /* 4个选项，每个约占1/4 */
            min-width: 160px; /* 防止在小屏幕上挤压变形 */
            text-align: center;
        }
        .options-container label {
            display: block; /* 保持block以便于点击 */
            margin: 8px 0;
            font-size: 1.1em;
            cursor: pointer;
            padding: 8px 5px; /* 增加内边距 */
            border-radius: 4px;
        }
        /* --- 修改：悬停效果 --- */
        .options-container label:hover {
            background-color: #f0f0f0; /* 浅灰色悬停效果 */
        }
        .options-container input[type="radio"] {
            margin-right: 10px;
        }
        button[type="submit"] {
            display: block;
            width: 100%;
            margin-top: 20px;
            padding: 12px 20px;
            font-size: 1.2em;
            font-weight: bold;
            color: white;
            background-color: #007bff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        button[type="submit"]:hover {
            background-color: #0056b3;
        }
    </style>
</head>
<body>

    <div class="survey-container">
        <h1 style="text-align: center;">Dota 2 Draft Rating Survey</h1>
        
        <p style="text-align: center;">As an experienced Dota 2 player, please rate the advantage/disadvantage of the following drafts.</p>
        
        <form id="draftSurvey" action="https://formspree.io/f/xnnoayda" method="POST">
    
            <button type="submit">Submit Survey</button>
        </form>
    </div>

    <script>
    // 确保在文档加载完毕后执行
    document.addEventListener('DOMContentLoaded', loadData);

    // 异步加载JSON数据并构建表单
    async function loadData() {
        try {
            // 并发请求两个JSON文件
            const [draftsResponse, heroesResponse] = await Promise.all([
                fetch('draft_results.json'),
                fetch('heroes.json')
            ]);

            if (!draftsResponse.ok) throw new Error(`Failed to load draft_results.json: ${draftsResponse.statusText}`);
            if (!heroesResponse.ok) throw new Error(`Failed to load heroes.json: ${heroesResponse.statusText}`);

            const draftsData = await draftsResponse.json();
            const heroesData = await heroesResponse.json();

            // 建立英雄ID到信息的映射
            const heroMap = {};
            for (const heroKey in heroesData) {
                const heroInfo = heroesData[heroKey];
                // 修正 Outworld Destroyer 的图片路径
                if (heroInfo.id === 76 && heroInfo.image.includes("outworld_destroyer")) {
                     heroInfo.image = "https://cdn.cloudflare.steamstatic.com/apps/dota2/images/heroes/obsidian_destroyer_full.png";
                }
                heroMap[heroInfo.id] = {
                    "name": heroInfo.name,
                    "image": heroInfo.image
                };
            }

            // 获取英雄信息 (带HTML转义)
            function getHeroInfo(heroId) {
                const defaultInfo = {
                    "name": "Unknown",
                    "image": "https://cdn.cloudflare.steamstatic.com/apps/dota2/images/heroes/npc_dota_hero_default_full.png"
                };
                const info = heroMap[heroId] ? { ...heroMap[heroId] } : { ...defaultInfo };

                info.name = info.name.replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                info.image = info.image.replace(/"/g, '&quot;');
                return info;
            }

            const formContainer = document.getElementById('draftSurvey');
            let formHTML = ''; // 存储生成的HTML

            // 遍历所有比赛阵容
            for (const draft of draftsData) {
                const draftId = draft.id.replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                // --- 生成Picks和Bans的HTML ---
                const radiantPicksHtml = draft.R.map(hero => getHeroInfo(hero.hero_id)).map(info =>
                    `<img class="hero-image" src="${info.image}" alt="${info.name}" title="${info.name}">`
                ).join('');

                const direPicksHtml = draft.D.map(hero => getHeroInfo(hero.hero_id)).map(info =>
                    `<img class="hero-image" src="${info.image}" alt="${info.name}" title="${info.name}">`
                ).join('');

                const radiantBansHtml = (draft.B && draft.B.R) ? draft.B.R.map(id => getHeroInfo(id)).map(info =>
                    `<img class="hero-image" src="${info.image}" alt="${info.name}" title="${info.name}">`
                ).join('') : '';

                const direBansHtml = (draft.B && draft.B.D) ? draft.B.D.map(id => getHeroInfo(id)).map(info =>
                    `<img class="hero-image" src="${info.image}" alt="${info.name}" title="${info.name}">`
                ).join('') : '';

                // --- 组合成一个问卷题目 ---
                formHTML += `
                <div class="draft-question" id="question-${draftId}">
                    <h3>Rate the balance of the following draft: (ID: ${draftId})</h3> 
                    <div class="draft-display">
                        <div class="team-column" id="radiant">
                            <h4>Radiant</h4>
                            <div class="picks-section"><h5>Pick</h5><div class="hero-images-container">${radiantPicksHtml}</div></div>
                            <div class="bans-section"><h5>Ban</h5><div class="hero-images-container">${radiantBansHtml}</div></div>
                        </div>
                        <div class="team-column" id="dire">
                            <h4>Dire</h4>
                            <div class="picks-section"><h5>Pick</h5><div class="hero-images-container">${direPicksHtml}</div></div>
                            <div class="bans-section"><h5>Ban</h5><div class="hero-images-container">${direBansHtml}</div></div>
                        </div>
                    </div>
                    <fieldset class="options-container">
                        <legend>Please rate the balance:</legend>
                        
                        <div class="options-flex-wrapper">
                        ${['A. Even Match', 'B. Slight Imbalance', 'C. Clear Imbalance', 'D. Total Stomp'].map((label, index) => ` 
                        <div>
                            <label>
                                <input type="radio" name="${draftId}" value="${String.fromCharCode(65 + index)}" required> ${label}
                            </label>
                        </div>`).join('')}
                        </div>
                    </fieldset>
                </div>
                `;
            }

            // 注入HTML并添加提交按钮
            formContainer.innerHTML = formHTML + `<button type="submit">Submit Survey</button>`; 

            // 绑定提交事件
            formContainer.addEventListener('submit', handleSubmit);

        } catch (error) {
            // 处理加载失败
            console.error("Error loading survey data:", error); 
            
            // *** 修改：修复了错误提示的颜色 ***
            document.querySelector('.survey-container').innerHTML = 
                `<h2 style="color: red; text-align: center;">Failed to load survey</h2> 
                 <p style="text-align: center;">Please ensure 'draft_results.json' and 'heroes.json' are in the same directory as 'index.html'.</p> 
                 <p style="text-align: center; color: #666;">Error details: ${error.message}</p>`; 
        }
    }

    // 表单提交处理函数 (无需修改)
    async function handleSubmit(event) {
        event.preventDefault(); // 阻止表单默认的跳转行为

        const form = event.target;
        const formData = new FormData(form);
        const results = {};
        let allAnswered = true;
        const questions = form.querySelectorAll('.draft-question');

        // 检查所有题目是否都回答了
        for (const question of questions) {
            const draftId = question.id.split('-')[1];
            if (!formData.has(draftId)) {
                allAnswered = false;
                question.style.border = '2px solid red';
                question.style.borderRadius = '8px';
            } else {
                question.style.border = '';
                question.style.borderRadius = '';
            }
        }

        if (!allAnswered) {
            alert('Please complete all questions before submitting! Unanswered questions are highlighted in red.'); 
            return;
        }

        // 将数据处理为
        for (const [key, value] of formData.entries()) {
            results[key] = value;
        }

        // POST数据到Formspree
        const submitButton = form.querySelector('button[type="submit"]');
        try {
            // 禁用按钮，防止重复提交
            submitButton.disabled = true;
            submitButton.textContent = 'Submitting...'; 

            // 使用 fetch API 异步提交数据
            const response = await fetch(form.action, {
                method: form.method,
                body: JSON.stringify(results), // 将结果转为JSON字符串发送
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json' // 告诉Formspree我们发送的是JSON
                }
            });

            // 提交成功
            if (response.ok) {
                alert('Thank you for your submission! Data sent successfully.'); 
                // 显示感谢信息
                const surveyContainer = form.parentElement;
                form.style.display = 'none';
                const thanksMsg = document.createElement('h2');
                thanksMsg.textContent = 'Thank you for participating!'; 
                thanksMsg.style.textAlign = 'center';
                thanksMsg.style.color = '#82dd75';
                surveyContainer.appendChild(thanksMsg);
            } else {
                // 提交失败
                throw new Error('Server response failed'); 
            }

        } catch (error) {
            // 网络或其他错误
            console.error('Submission error:', error); 
            alert('Submission failed. Please check your internet connection and try again.'); 
            submitButton.disabled = false;
            submitButton.textContent = 'Submit Survey'; 
        }
    }
</script>

</body>
</html>
